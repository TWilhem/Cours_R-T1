name: Update Files

on: [push]

jobs:
  update_files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up environment
      run: |
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v45
      with:
        separator: "|"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Check for changed files
      id: check-changes
      run: |
        Fichier=()
        
        input_string='${{ steps.changed-files.outputs.all_changed_files }}'
        
        python_script=$(cat << EOF
        import sys
        import os

        input_string = sys.argv[1]
        files = input_string.split('|')

        for file in files:
            decoded_file = file.encode('latin1').decode('utf-8')
            if "README.md" not in decoded_file and "1er Semestre/" in decoded_file:
                print(decoded_file)
        EOF
            )
            
            while IFS= read -r decoded_file; do
              Fichier+=("$decoded_file")
            done < <(python -c "$python_script" "$input_string")
            
            if [ ${#Fichier[@]} -gt 0 ]; then
              echo "Tous les fichiers détectés :"
              for f in "${Fichier[@]}"; do
                echo "$f"
              done
            else
              echo "Aucun fichier détecté."
            fi
          shell: /usr/bin/bash -e {0}


    # - name: Commit changes
    #   if: 
    #   run: |
    #     git config --local user.email "action@github.com"
    #     git config --local user.name "GitHub Action"
    #     git add .
    #     git diff --quiet && git diff --staged --quiet || git commit -m "Mise à jour automatique des fichiers (hors README)"
    #     git push


# Ajout du fait qu'il n'execute pas si les premier dossier ne sont pas dans 1er semestre, etc
# Faire une boucle pour traiter les fichiers
# verifier si il y a bien un fichier README dans le dossier parent
# mettre le lien dans la bonne ligne (CM, TD, TP)
